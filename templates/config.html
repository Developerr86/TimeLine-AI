<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>TimeLine AI - Configuration</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
</head>
<body>
    <div class="app-container">
        <!-- Left Sidebar -->
        <aside class="sidebar">
            <div class="logo">
                <div class="logo-icon">‚öôÔ∏è</div>
            </div>
            <nav class="sidebar-nav">
                <a href="/" class="nav-item" title="Timeline">
                    <span class="icon">üìä</span>
                </a>
                <a href="#" class="nav-item" title="Analytics">
                    <span class="icon">üìà</span>
                </a>
                <a href="#" class="nav-item" title="Calendar">
                    <span class="icon">üìÖ</span>
                </a>
                <a href="/config" class="nav-item active" title="Settings">
                    <span class="icon">‚öôÔ∏è</span>
                </a>
                <a href="#" class="nav-item" title="Info">
                    <span class="icon">‚ÑπÔ∏è</span>
                </a>
            </nav>
        </aside>

        <!-- Main Content -->
        <main class="main-content">
            <!-- Header -->
            <header class="header">
                <h1 class="page-title">Configuration</h1>
                <a href="/" class="btn-secondary" style="text-decoration: none;">‚Üê Back to Timeline</a>
            </header>

            <div style="max-width: 800px;">
                <div class="config-panel">
                    <h2>‚öôÔ∏è Settings</h2>
                    
                    <form id="configForm" onsubmit="saveConfig(event)">
                        <div class="form-group">
                            <label for="interval">Screenshot Interval (seconds)</label>
                            <input type="number" id="interval" name="interval" value="{{ config.interval }}" min="1" max="300" required>
                            <small>How often to capture screenshots (1-300 seconds)</small>
                        </div>

                        <div class="form-group">
                            <label for="similarity_threshold">Similarity Threshold</label>
                            <input type="number" id="similarity_threshold" name="similarity_threshold" 
                                   value="{{ config.similarity_threshold }}" min="0" max="1" step="0.01" required>
                            <small>Images above this similarity (0-1) will be discarded. Recommended: 0.95</small>
                        </div>

                        <div class="form-group">
                            <label for="notes_history_limit">Notes History Limit</label>
                            <input type="number" id="notes_history_limit" name="notes_history_limit" 
                                   value="{{ config.notes_history_limit if config.notes_history_limit else 5 }}" min="1" max="100" required>
                            <small>Number of recent activities to use when generating notes (Default: 5)</small>
                        </div>

                        <div class="form-group">
                            <label for="notes_model_provider">Notes AI Provider</label>
                            <select id="notes_model_provider" name="notes_model_provider" onchange="toggleNotesModelOptions()">
                                <option value="gemini" {% if config.notes_model_provider == 'gemini' %}selected{% endif %}>Google Gemini (Cloud)</option>
                                <option value="ollama" {% if config.notes_model_provider == 'ollama' %}selected{% endif %}>Ollama (Local)</option>
                            </select>
                            <small>Choose which AI provider to use for generating notes.</small>
                        </div>

                        <div class="form-group" id="notesOllamaModelGroup" style="display: none;">
                            <label for="notes_ollama_model">Ollama Notes Model</label>
                            <input type="text" id="notes_ollama_model" name="notes_ollama_model" value="{{ config.notes_ollama_model if config.notes_ollama_model else 'llama3' }}">
                            <small>Text model for notes (e.g., llama3, mistral, qwen2.5)</small>
                        </div>
                        
                        <hr style="margin: 20px 0; border: 0; border-top: 1px solid #eee;">

                        <div class="form-group">
                            <label for="model_type">Screenshot AI Model Type</label>
                            <select id="model_type" name="model_type" onchange="toggleModelOptions()">
                                <option value="ollama" {% if config.model_type == 'ollama' %}selected{% endif %}>Ollama (Local)</option>
                                <option value="gemini" {% if config.model_type == 'gemini' %}selected{% endif %}>Google Gemini (Cloud)</option>
                                <option value="remote" {% if config.model_type == 'remote' %}selected{% endif %}>Remote Server (Custom URL)</option>
                            </select>
                            <small>Choose between local processing (Ollama), cloud-based (Gemini), or a custom remote server.</small>
                        </div>

                        <div class="form-group" id="ollamaModelGroup">
                            <label for="ollama_model">Ollama Model Name</label>
                            <input type="text" id="ollama_model" name="ollama_model" value="{{ config.ollama_model }}">
                            <small>e.g., qwen2.5vl:3b, llava, bakllava</small>
                        </div>

                        <div class="form-group" id="geminiModelGroup">
                            <label for="gemini_model">Gemini Model Name</label>
                            <input type="text" id="gemini_model" name="gemini_model" value="{{ config.gemini_model }}">
                            <small>e.g., gemini-2.5-pro, gemini-2.0-flash</small>
                        </div>

                        <div class="form-group" id="remoteModelGroup">
                            <label for="remote_url">Remote Server URL</label>
                            <input type="text" id="remote_url" name="remote_url" value="{{ config.remote_url if config.remote_url else 'http://localhost:5001/predict' }}">
                            <small>Full URL to the prediction endpoint (e.g., http://localhost:5001/predict)</small>
                        </div>

                        <div class="form-actions">
                            <button type="submit" class="btn-primary">üíæ Save Configuration</button>
                            <a href="/" class="btn-secondary">Cancel</a>
                        </div>
                    </form>
                </div>
                
                <div class="config-panel" style="margin-top: 20px; border: 1px solid #e74c3c;">
                    <h2 style="color: #e74c3c;">‚ö†Ô∏è Danger Zone</h2>
                    <p>These actions cannot be undone.</p>
                    
                    <div class="form-group">
                        <label>Clear Context</label>
                        <p style="color: #666; font-size: 0.9em; margin-top: 5px;">
                            This will delete all captured screenshots and clear the activity history (responses.json).
                            Use this to start fresh.
                        </p>
                        <button type="button" onclick="clearContext()" class="btn-danger" style="background-color: #e74c3c; color: white; border: none; padding: 10px 15px; border-radius: 6px; cursor: pointer; font-weight: bold; margin-top: 10px;">
                            üóëÔ∏è Clear All Data
                        </button>
                    </div>
                </div>

                <div class="info-panel">
                    <h3>üí° Tips & Information</h3>
                    <ul>
                        <li><strong>Screenshot Interval:</strong> Lower values (3-5s) capture more frequently but use more resources. Higher values (10-30s) are more efficient.</li>
                        <li><strong>Similarity Threshold:</strong> Values between 0.90-0.99 work best. Higher = only very different screenshots are kept.</li>
                        <li><strong>Ollama:</strong> Runs completely offline on your computer. Requires Ollama installation and model download.</li>
                        <li><strong>Gemini:</strong> Cloud-based AI with higher accuracy. Requires internet connection and API key.</li>
                        <li><strong>Remote:</strong> Connect to a custom VLM server (like ml-fastvlm) running on another port/machine.</li>
                    </ul>
                    
                    <h3 style="margin-top: 2rem;">üìã Environment Variables</h3>
                    <ul>
                        <li><code>GEMINI_API_KEY</code> - Required for using Gemini model</li>
                        <li><code>OLLAMA_MODEL</code> - Default Ollama model name</li>
                        <li><code>GEMINI_MODEL</code> - Default Gemini model name</li>
                    </ul>
                    
                    <h3 style="margin-top: 2rem;">üîß Setup Instructions</h3>
                    <ul>
                        <li>Create a <code>.env</code> file in the project root</li>
                        <li>Add your API keys and model preferences</li>
                        <li>For Ollama: Install from <a href="https://ollama.ai" target="_blank">ollama.ai</a></li>
                        <li>For Gemini: Get API key from <a href="https://makersuite.google.com/app/apikey" target="_blank">Google AI Studio</a></li>
                    </ul>
                </div>
            </div>
        </main>
    </div>

    <script>
        function toggleModelOptions() {
            const modelType = document.getElementById('model_type').value;
            document.getElementById('ollamaModelGroup').style.display = 
                modelType === 'ollama' ? 'block' : 'none';
            document.getElementById('geminiModelGroup').style.display = 
                modelType === 'gemini' ? 'block' : 'none';
            document.getElementById('remoteModelGroup').style.display = 
                modelType === 'remote' ? 'block' : 'none';
        }
        
        function toggleNotesModelOptions() {
            const notesProvider = document.getElementById('notes_model_provider').value;
            document.getElementById('notesOllamaModelGroup').style.display = 
                notesProvider === 'ollama' ? 'block' : 'none';
        }

        async function saveConfig(event) {
            event.preventDefault();
            
            const formData = new FormData(event.target);
            const config = {
                interval: parseInt(formData.get('interval')),
                similarity_threshold: parseFloat(formData.get('similarity_threshold')),
                model_type: formData.get('model_type'),
                ollama_model: formData.get('ollama_model'),
                gemini_model: formData.get('gemini_model'),
                remote_url: formData.get('remote_url'),
                notes_history_limit: parseInt(formData.get('notes_history_limit')),
                notes_model_provider: formData.get('notes_model_provider'),
                notes_ollama_model: formData.get('notes_ollama_model')
            };
            
            try {
                const response = await fetch('/api/config', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(config)
                });
                
                const result = await response.json();
                
                if (result.status === 'success') {
                    alert('‚úÖ Configuration saved successfully!');
                    window.location.href = '/';
                } else {
                    alert('‚ùå Error saving configuration');
                }
            } catch (error) {
                alert('‚ùå Error: ' + error);
            }
        }

        async function clearContext() {
            if (!confirm('‚ö†Ô∏è ARE YOU SURE?\n\nThis will PERMANENTLY DELETE all screenshots and activity history.\n\nThis action cannot be undone.')) {
                return;
            }
            
            try {
                const response = await fetch('/api/clear_context', {
                    method: 'POST'
                });
                
                const result = await response.json();
                
                if (result.status === 'success') {
                    alert('‚úÖ All data has been cleared successfully.');
                    window.location.href = '/';
                } else {
                    alert('‚ùå Error clearing data: ' + result.message);
                }
            } catch (error) {
                alert('‚ùå Error: ' + error);
            }
        }

        toggleModelOptions();
        toggleNotesModelOptions();
    </script>
</body>
</html>
